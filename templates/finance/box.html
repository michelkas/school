{% extends "base.html" %}
{% block content %}
  {% include "includes/nav_bar_finance.html" %}

  <div class="container-fluid finance-bg">
    <div class="row">
      <main class="col-md-12 py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="fw-bold text-primary">Tableau de bord caisse</h3>
          <div>
            <a href="{% url 'finance:add_payment' %}" class="btn btn-success me-2 shadow-sm">Ajouter un paiement</a>
          </div>
        </div>
        <div class="row gy-3">
          <div class="col-md-4">
            <div class="card shadow finance-card-gradient">
              <div class="card-body">
                <h6 class="card-subtitle mb-2 text-white-50">Total Transactions (aujourd'hui)</h6>
                <h3 id="todaySales" class="currency text-white">{{ total_today }} FC</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow finance-card-gradient">
              <div class="card-body">
                <h6 class="card-subtitle mb-2 text-white-50">Nombre transactions</h6>
                <h3 id="countTx" class="text-white">{{ count_today }}</h3>
              </div>
            </div>
          </div>
        </div>
        <style>
          .finance-bg {
            background: linear-gradient(120deg, #e3f6fc 0%, #f6fafd 100%);
            min-height: 100vh;
          }
          .finance-card-gradient {
            background: linear-gradient(135deg, #0d6efd 60%, #20c997 100%);
            border: none;
          }
          .finance-filters {
            background: #f8f9fa;
            border-radius: 14px;
            padding: 18px 10px 8px 10px;
            margin-bottom: 28px;
            box-shadow: 0 2px 16px rgba(32,201,151,0.08);
            animation: fadeIn 0.5s;
          }
          .finance-filters label {
            font-weight: 600;
            color: #0d6efd;
            margin-bottom: 2px;
          }
          .finance-filters select {
            min-width: 110px;
            border-radius: 7px;
            border: 1.5px solid #20c997;
            transition: border-color 0.18s, box-shadow 0.18s;
            background: #fafdff;
          }
          .finance-filters select:focus {
            border-color: #0d6efd;
            outline: none;
            box-shadow: 0 0 0 0.15rem #b6d4fe;
          }
          .finance-filters .btn {
            transition: background 0.18s, color 0.18s;
          }
          .finance-filters .btn:hover {
            background: #20c997;
            color: #fff;
          }
          .table-animated {
            animation: fadeInUp 0.5s;
          }
          .table-striped tbody tr {
            transition: background 0.18s;
          }
          .table-striped tbody tr:hover {
            background: #e3f6fc;
          }
          .table thead {
            background: linear-gradient(90deg, #0d6efd 60%, #20c997 100%);
          }
          .table thead th {
            color: #fff;
            font-weight: 600;
            border: none;
          }
          .table td, .table th {
            vertical-align: middle;
          }
          .btn-outline-secondary {
            border-color: #20c997;
            color: #20c997;
          }
          .btn-outline-secondary:hover {
            background: #20c997;
            color: #fff;
          }
          .loader {
            display: none;
            position: fixed;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(255,255,255,0.7);
            z-index: 9999;
            align-items: center; justify-content: center;
          }
          .loader.active {
            display: flex;
          }
          .loader .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #0d6efd;
            border-radius: 50%;
            width: 54px; height: 54px;
            animation: spin 0.9s linear infinite;
          }
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
          }
          @media (max-width: 768px) {
            .finance-filters .col-md-2, .finance-filters .col-md-3, .finance-filters .col-auto { flex: 0 0 100%; max-width: 100%; margin-bottom: 10px; }
          }
        </style>
        <div class="loader" id="loader"><div class="spinner"></div></div>
        <div class="card mt-4 shadow-sm">
          <div class="card-body">
            <form method="get" class="row g-3 finance-filters mb-4" id="filter-form">
              <div class="col-md-2">
                <label for="classe" class="form-label">Classe</label>
                <select class="form-select" name="classe" id="classe">
                  <option value="" {% if not request.GET.classe %}selected{% endif %}>Toutes classes</option>
                  {% for c in classes %}
                    <option value="{{ c }}" {% if request.GET.classe == c|stringformat:'s' %}selected{% endif %}>{{ c }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2">
                <label for="section" class="form-label">Section</label>
                <select class="form-select" name="section" id="section">
                  <option value="" {% if not request.GET.section %}selected{% endif %}>Toutes sections</option>
                  {% for s in sections %}
                    <option value="{{ s }}" {% if request.GET.section == s|stringformat:'s' %}selected{% endif %}>{{ s }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2">
                <label for="option" class="form-label">Option</label>
                <select class="form-select" name="option" id="option">
                  <option value="" {% if not request.GET.option %}selected{% endif %}>Toutes options</option>
                  {% for o in options %}
                    <option value="{{ o }}" {% if request.GET.option == o|stringformat:'s' %}selected{% endif %}>{{ o }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2">
                <label for="fees_type" class="form-label">Type de frais</label>
                <select class="form-select" name="fees_type" id="fees_type">
                  <option value="" {% if not request.GET.fees_type %}selected{% endif %}>Tous types de frais</option>
                  {% for f in fees_types %}
                    <option value="{{ f }}" {% if request.GET.fees_type == f|stringformat:'s' %}selected{% endif %}>{{ f }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2">
                <label for="mois" class="form-label">Mois</label>
                <select class="form-select" name="mois" id="mois">
                  <option value="" {% if not request.GET.mois %}selected{% endif %}>Tous les mois</option>
                  {% for mois in mois_list %}
                    <option value="{{ mois }}" {% if request.GET.mois == mois|stringformat:'s' %}selected{% endif %}>{% if mois == 1 %}Septembre{% elif mois == 2 %}Octobre{% elif mois == 3 %}Novembre{% elif mois == 4 %}Décembre{% elif mois == 5 %}Janvier{% elif mois == 6 %}Février{% elif mois == 7 %}Mars{% elif mois == 8 %}Avril{% elif mois == 9 %}Mai{% elif mois == 10 %}Juin{% else %}{{ mois }}{% endif %}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2 align-self-end">
                <a href="?" class="btn btn-outline-secondary w-100">Effacer</a>
              </div>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const form = document.getElementById('filter-form');
                  const selects = form.querySelectorAll('select');
                  const loader = document.getElementById('loader');
                  const sectionSelect = document.getElementById('section');
                  const classeSelect = document.getElementById('classe');
                  const optionSelect = document.getElementById('option');

                  function updateOptionState() {
                    const sectionVal = sectionSelect.value ? sectionSelect.value.toLowerCase() : '';
                    const classeVal = classeSelect.value ? classeSelect.value.toLowerCase() : '';
                    let disable = false;
                    if (sectionVal === 'primaire' || classeVal === '7eme' || classeVal === '8eme' || classeVal === '7ème' || classeVal === '8ème') {
                      disable = true;
                    }
                    optionSelect.disabled = disable;
                    optionSelect.style.background = disable ? '#e9ecef' : '#fff';
                    optionSelect.title = disable ? "Option non disponible pour cette section ou classe" : "";
                  }

                  sectionSelect.addEventListener('change', updateOptionState);
                  classeSelect.addEventListener('change', updateOptionState);
                  updateOptionState();

                  selects.forEach(function(select) {
                    select.addEventListener('change', function() {
                      if(loader) loader.classList.add('active');
                      setTimeout(() => form.submit(), 120);
                    });
                  });
                  window.addEventListener('pageshow', function() {
                    if(loader) loader.classList.remove('active');
                  });
                });
              </script>
            </form>

            <div class="table-responsive table-animated">
              <table class="table table-striped table-fixed">
                <thead class="table-light">
                  <tr>
                    <th>Classe</th>
                    <th>Section</th>
                    <th>Option</th>
                    <th>Mois</th>
                    <th>Type de frais</th>
                    <th>Nom</th>
                    <th>Identifiant</th>
                    <th>Montant attendu</th>
                    <th>Montant payé</th>
                    <th>Statut</th>
                  </tr>
                </thead>
                <tbody>
                  {% for classe, sections in groupe_per_classe.items %}
                    {% for section, options in sections.items %}
                      {% for option, mois_dict in options.items %}
                        {% for mois, frais_dict in mois_dict.items %}
                          {% for fees_name, infos in frais_dict.items %}
                            {% for info in infos %}
                              <tr>
                                <td  class="text-muted">{{ classe }}</td>
                                <td  class="text-muted">{{ section }}</td>
                                <td  class="text-muted">{{ option }}</td>
                                <td  class="text-muted">{{ mois }}</td>
                                <td  class="text-muted">{{ fees_name }}</td>
                                <td><a href="{% url "finance:show_box" info.student_id %}" class="text" style="color:black;">  <strong>{{ info.student_name }} {{ info.student_first_name }}</strong></a></td>
                                <td><a href="{% url "finance:show_box" info.student_id %}" class="text" style="color:black;"> <strong> {{ info.matricule }} </strong></a></td>
                                <td  class="text-muted">{{ info.fees_mount|floatformat:2 }} FC</td>
                                <td><strong>  {{ info.total|floatformat:2 }} FC</strong></td>
                                <td  class="text-muted">{{ info.statut|safe }}</td>
                              </tr>
                            {% endfor %}
                          {% endfor %}
                        {% endfor %}
                      {% endfor %}
                    {% endfor %}
                  {% empty %}
                    <tr><td colspan="10" class="text-center">Aucune donnée trouvée.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <nav>
              <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                  <li class="page-item"><a class="page-link" href="?{% if request.GET.classe %}classe={{ request.GET.classe }}&{% endif %}{% if request.GET.section %}section={{ request.GET.section }}&{% endif %}{% if request.GET.option %}option={{ request.GET.option }}&{% endif %}{% if request.GET.fees_type %}fees_type={{ request.GET.fees_type }}&{% endif %}{% if request.GET.mois %}mois={{ request.GET.mois }}&{% endif %}page={{ page_obj.previous_page_number }}">Précédent</a></li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">Précédent</span></li>
                {% endif %}
                <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}</span></li>
                {% if page_obj.has_next %}
                  <li class="page-item"><a class="page-link" href="?{% if request.GET.classe %}classe={{ request.GET.classe }}&{% endif %}{% if request.GET.section %}section={{ request.GET.section }}&{% endif %}{% if request.GET.option %}option={{ request.GET.option }}&{% endif %}{% if request.GET.fees_type %}fees_type={{ request.GET.fees_type }}&{% endif %}{% if request.GET.mois %}mois={{ request.GET.mois }}&{% endif %}page={{ page_obj.next_page_number }}">Suivant</a></li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">Suivant</span></li>
                {% endif %}
              </ul>
            </nav>

          </div>
        </div>

      </main>
    </div>
  </div>
{% endblock content %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

